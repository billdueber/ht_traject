#!/bin/bash

if [ $# -gt 1 ] 
then
  echo
  echo "fullindex: empty the catalog and index the most recent monthly"
  echo
  echo "USAGE:"
  echo "    fullindex filename <optional logfile>"
  echo
  exit
fi

HERE=`dirname $0`
SCRIPTDIR=`realpath $HERE`

logfile=$1

source $SCRIPTDIR/set_java_home.sh
source $SCRIPTDIR/utils.sh

# where do we keep the data?
DDIR=/htsolr/catalog/prep

# Full indexes are dated the last day of the month
# Let's find it

# First day of this month
first="$(date +"%Y%m")01"
# Last day of last month
last_day_of_last_month=`date -d "$first - 1 day" +"%Y%m%d"`

marcfile="${DDIR}/zephir_full_${last_day_of_last_month}_vufind.json.gz"

echo Targeting $SOLR_URL
read -p "Deleting everything in $SOLR_URL. Right? Right??? Y/N (N) > " GO_ON

if [[ "$GO_ON" == [Yy]  ]]
then
    log "Empty solr"
    empty_solr
    log "Index $marcfile"
    $SCRIPTDIR/bundle exec $SCRIPTDIR/index_file $marcfile $logfile
    log "Catch up since $last_day_of_last_month"
   $SCRIPTDIR/bundle exec $SCRIPTDIR/catchup_since $last_day_of_last_month $logfile
else
  echo "OK. Aborting. Will not empty or index"
  exit 1
fi

commit


